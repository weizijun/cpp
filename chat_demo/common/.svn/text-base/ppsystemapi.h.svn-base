#ifndef __PP_SYSTEM_API_H__
#define __PP_SYSTEM_API_H__

#include "ppbase.h"

#if (defined(WIN32) || defined(WIN64))
#include <winsock2.h>
#include <windows.h>
#else
#include <pthread.h>
extern "C" {
#include "libcoro/coro.h"
}
typedef bool BOOL;
#endif

namespace PPCool
{

#if (defined(WIN32) || defined(WIN64))

//通用
typedef HANDLE PPHANDLE;
#define PPINVALID_HANDLE  (NULL)
//用于锁
typedef CRITICAL_SECTION LockID;
//用于线程
typedef unsigned int (WINAPI *PFThreadProc)(void *);
#define PPTHREAD_DECLARE(x)  unsigned int WINAPI  x
#define PPTHREAD_RETURN(x)   return x;
//用于协程
typedef void (WINAPI *PFCoroutineProc)(void *);
typedef void * PPCoroContext;
//用于条件变量
typedef CONDITION_VARIABLE PPCondition;

#else

//通用
#ifndef TRUE
#define TRUE (true)
#endif
#ifndef FALSE
#define FALSE (false)
#endif
typedef int PPHANDLE;
#define PPINVALID_HANDLE  (0)
#define INFINITE 0xFFFFFFFF
//用于锁
typedef pthread_mutex_t LockID;
//用于线程
typedef void * (*PFThreadProc)(void *);
#define PPTHREAD_DECLARE(x)  void *  x
#define PPTHREAD_RETURN(x)   return x;
//用于协程
typedef void (*PFCoroutineProc)(void *);
typedef coro_context* PPCoroContext;
//用于条件变量
typedef pthread_cond_t PPCondition;

#endif

class IPPSystemAPI
{
protected:
	IPPSystemAPI();
	virtual ~IPPSystemAPI();

private:
	static IPPSystemAPI * m_pInstance;
	
public:
	static IPPSystemAPI* Instance();

	static void DestroyInstance();

public:
	virtual void Sleep(unsigned int milliseconds) = 0;

	virtual void InitLock(LockID & id) = 0;

	virtual void DestroyLock(LockID & id) = 0;

	virtual void Lock(LockID & id) = 0;

	virtual void Unlock(LockID & id) = 0;

	virtual void InitCondition(PPCondition & hCondition) =0;

	virtual void DestroyCondition(PPCondition & hCondition) =0;

	virtual int WaitCondition(PPCondition & hCondition, LockID & hLock, unsigned int TimeOut) =0;

	virtual void NotifyCondition(PPCondition & hCondition) =0;

	virtual void NotifyAllCondition(PPCondition & hCondition) =0;

	virtual PPHANDLE CreateThread(PFThreadProc pfThrdProc, void *pArg, BOOL bSuspend = FALSE) = 0;

	virtual void JoinThread(PPHANDLE hThread, int timeout = INFINITE) = 0;

	virtual void TerminateThread(PPHANDLE hThread, unsigned long ExitCode = 0) = 0;

	virtual void ResumeThread(PPHANDLE hThread) = 0;

	virtual void SuspendThread(PPHANDLE hThread) = 0;

	virtual PPCoroContext CreateCoroutine(unsigned int StackSize, PFCoroutineProc pfCoroProc, void * pParam) =0;

	virtual void TerminateCoroutine(PPCoroContext hCoroContext) =0;

	virtual void SwitchCoroutine(PPCoroContext hOldCoroContext, PPCoroContext hNewCoroContext) =0;
};

};

#endif
